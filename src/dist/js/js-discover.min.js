function forgotPassword(){"/discover/"===location.pathname?angular.element(document.body).injector().get("modalSrv").closeAll():($("#login").hide(),$("#forgot").removeClass("hidden").fadeIn(300))}function backLogin(){"/discover/"===location.pathname?(angular.element(document.body).injector().get("modalSrv").closeAll(),angular.element(document.body).injector().get("modalSrv").login()):($("#login").fadeIn(300),$("#forgot").hide())}function showLogin(){"/discover/"===location.pathname?angular.element(document.body).injector().get("modalSrv").login():($("#forgot").hide(),$("#loginModal").modal("show"),$("#login").fadeIn(500),$(".login-form-mode-only").removeClass("hidden").fadeIn(300),$(".signup-form-mode-only").addClass("hidden").fadeOut(300))}function showSignup(){"/discover/"===location.pathname?angular.element(document.body).injector().get("modalSrv").signup():location.href="/register"}function oAuthRedirect(e,t,r){var o,n=location.origin+location.pathname,a=locationService.getURLParams(),i=e||{};a.auth="idplaceholder",a=$.extend({},i,a),o=bloombeesOAuthUrl+"/"+t+"?ret="+encodeURIComponent(n+"?"+$.param(a)),o=o.replace("idplaceholder","{id}"),location.href=o}function socialNetworkLogin(e){var t={};displayLoader(),oAuthRedirect(t,e,!1)}function socialNetworkSignup(e){var t={};displayLoader(),oAuthRedirect(t,e,!0)}function loginAPICall(e,t){var r={email:e,password:t};return $.post(bloombeesApiUrl+endpoints.login,r).then(function(e){var t=null;return e.data.data&&(t=e.data.data.dstoken),t})}function displayError(){var e=$("#loginModal").find(".loader-container");e.addClass("error"),setTimeout(function(){e.addClass("animated zoomOut"),setTimeout(function(){e.removeClass("animated zoomOut active error")},800)},1500)}function loginFormSubmit(){var e,t=$("#loginModal").find(".loader-container"),r=["discover"],o=locationService.getURLParameter("next"),n=$("form[name=loginForm]").serializeArray(),a=null,i=null;n.forEach(function(e){"email"===e.name&&(a=e.value),"password"===e.name&&(i=e.value)}),t.addClass("active"),loginAPICall(a,i).then(function(t){t&&(o?(e=o,$.cookie("bbtoken",t,{path:"/"}),location.assign("/app/#"+e)):(e="/app/#/merchant/dashboard",r.forEach(function(t){location.href.indexOf(t)>-1&&(e=location.href)}),location.assign(e)))},displayError)}function signupFormSubmit(){}function forgotFormSubmit(){}var forms={loginForm:$("form[name=loginForm]"),forgotForm:$("form[name=forgotForm]")},endpoints={login:"/auth/userpassword",signup:"/register/user",confirmOAuth:"/auth/oauthservice",confirmOAuthSignup:"/register/user/oauthservice"};$(document).ready(function(){"#login"===window.location.hash&&showLogin()});var app=angular.module("beeViral",["ui.router","ngCookies","ngAnimate","ngResource","ngDialog","angularMoment","rzModule","LocalStorageModule","dndLists","ngTagsInput","720kb.socialshare"]);app.config(["$locationProvider","$urlRouterProvider","$httpProvider","$stateProvider","$cookiesProvider",function(e,t,r,o,n){e.html5Mode(!0),r.defaults.useXDomain=!0,delete r.defaults.headers.common["X-Requested-With"],n.defaults.path="/",r.interceptors.push(["$q",function(e){return{responseError:function(t){return 401===t.status&&location.replace("/auth/logout?ret=/discover"),e.reject(t)}}}]),o.state({name:"root",url:"",abstract:!0,template:"<ui-view/>",resolve:{bbhash:["$cookies","$resource","BLOOMBEES_API_URL",function(e,t,r){e.get("bbhash")||t(r+"/auth/hash").get(function(t){e.put("bbhash",t.data)})}]}}),o.state({name:"root.discover",url:"/:uniqueId?view&cat&subcat&order&priceMin&priceMax&search&bbcode&newAccount",templateUrl:"influencer/discover.html",controller:"DiscoverController",controllerAs:"discover",resolve:{bbcode:["$location","modalSrv",function(e,t){var r=e.search();isAuth||!r||!r.bbcode||r.auth||r.emailRequired||(t.signup(r.bbcode),e.search("bbcode",null))}],productSections:["$q","discoverSrv","$stateParams",function(e,t,r){var o=e.defer(),n=r.uniqueId||null;return t.sections?o.resolve():t.getProductSections(n).then(function(e){t.sections=e.data.Discover_sections,o.resolve()}),o.promise}],categories:["$q","LANGUAGE","discoverSrv",function(e,t,r){var o=e.defer();return r.categories.length>0?o.resolve():r.getCategories(t).then(function(e){r.categories=e.data.TagCats,o.resolve()}),o.promise}]}}),t.otherwise("/")}]),app.run(["$log","$rootScope","$timeout","$window","$document","$cookies","$http","$q","ENVIRONMENT","$location","locationSrv","loginSrv","$state","modalSrv",function(e,t,r,o,n,a,i,c,s,l,u,d,p,f){function m(){f.notice("That social network profile or the email associated to it are already in use","Ok")}function h(){f.notice("User not found, please sign up","Ok")}function g(){r(function(){v.addClass("animated zoomOut"),r(function(){v.removeClass("active animated zoomOut")},350)},100)}var v=n.find(".loader-container"),b=l.search(),S=0,E=!1,P=!1;t.$state=p,t.$on("$stateChangeStart",function(e,t,r,o,a){o.name!==t.name&&(v.addClass("active"),n.scrollTop(0))}),t.$on("$stateChangeSuccess",function(){l.search().auth||g()}),t.$on("ngDialog.opened",function(){function e(e){e.matches&&(n.find("body").addClass("no-scroll"),S=o.pageYOffset)}var t=o.matchMedia("screen and (max-width: 480px)");t.addListener(e),e(t)}),t.$on("ngDialog.closing",function(){function e(e){e.matches&&(n.find("body").removeClass("no-scroll"),o.scrollTo(0,S))}var t=o.matchMedia("screen and (max-width: 480px)");t.addListener(e),e(t)}),a.get("bbtoken")&&isAuth&&r(function(){i.defaults.headers.common["X-DS-TOKEN"]=a.get("bbtoken")}),i.defaults.headers.common["X-WEB-KEY"]=s,i.defaults.headers.common["X-EXTRA-INFO"]=a.get("bbhash"),b&&b.auth&&(b.hasOwnProperty("emailRequired")&&(E=!0),b.signup&&(P=!0),d.confirmOAuth(b.auth,P,E).then(function(e){e.success?(a.put("bbtoken",e.bbtoken),u.reloadWithoutParams(["auth","signup","emailRequired"])):(f.closeAll(),g(),l.search("auth",null),l.search("signup",null),l.search("emailRequired",null),404===e.status?h():409===e.status?m():f.defaultNotice())}))}]),app.component("discoverFilters",{templateUrl:"partials/modals/discover-filters.html",controller:["$log","$state","modalSrv","discoverSrv","publicDataSrv","DISCOVER",function(e,t,r,o,n,a){var i=this;e.log(t.params),i.sliderOptions={hidePointerLabels:!0,hideLimitLabels:!0,boundPointerLabels:!1,ceil:a.DEFAULTS.PRICE_MAX,floor:0},i.$onInit=function(){i.currency=n.getActiveCurrency().Currency_symbol,i.filters={order:t.params.order||"",priceMin:t.params.priceMin||0,priceMax:t.params.priceMax||a.DEFAULTS.PRICE_MAX}},i.applyFilters=function(){t.go(t.current,angular.merge(t.params,i.filters),{reload:!0,notify:!0}),r.closeAll()}}]}),app.component("loginForm",{templateUrl:"partials/modals/login-form.html",controllerAs:"loginController",restrict:"E",bindings:{bbcode:"@"},replace:!0,controller:["LOGIN","loginSrv","modalSrv","BLOOMBEES_OAUTH_URL","translationsSrv","locationSrv",function(e,t,r,o,n,a){function i(e){r.openWithOptions({template:"partials/modals/account-exists.html",controller:["ngDialog","modalSrv","$scope",function(t,r,o){var n=this;l.fadeOut(200),n.signin=function(){r.closeAll(),r.login(e)},n.retypeEmail=function(){o.closeThisDialog(),l.fadeIn(300),u.focus()}}],controllerAs:"$ctrl",plain:!1})}var c=this,s="#"+r.getOpenDialogs()[0],l=angular.element(document).find(s),u=l.find("input#email");c.email="",c.password="",c.redirectUrl=encodeURIComponent(location.href+"?auth={id}"),c.oAuthUrl=o,c.loading=!0,c.oAuthRedirect=t.oAuthRedirect.bind(t,{bbcode:c.bbcode}),c.submit=function(){c.loading=!0,t.authenticate(c.email,c.password).then(function(e){e?c.bbcode?a.reloadWithParams({bbcode:c.bbcode}):location.reload():(c.loading=!1,r.defaultNotice())},function(e){404===e.data.status?i(c.bbcode):r.defaultNotice(),c.loading=!1})},c.goToSignup=function(){r.closeAll(),r.signup(c.bbcode)},c.loading=!1}]}),app.constant("LOGIN",{ENDPOINTS:{AUTH:"/auth2017",EMAIL_LOGIN:"/auth/userpassword",CONFIRM_OAUTH:"/auth/oauthservice",CONFIRM_OAUTH_SIGNUP:"/register/user/oauthservice"},DEFAULT_REDIRECT_URL:"/merchant/dashboard",TOKEN_COOKIE:"bbtoken",LOGIN_ERROR_RESPONSE:"Error: error-user-notfound",LOGIN_WRONG_PASSWORD_RESPONSE:"Error: error-user-wrong-password",USER_DOES_NOT_EXIST_RESPONSE:"Error: error-user-does-not-have-password",REQUIRE_EMAIL_TEMPLATE:"partials/modals/require_email.html"}),app.service("loginSrv",["LOGIN","$http","$q","BLOOMBEES_API_URL","modalSrv","LANGUAGE","$location","BLOOMBEES_OAUTH_URL","$cookies",function(e,t,r,o,n,a,i,c,s){function l(r,n){var a={email:r,password:n};return t.post(o+e.ENDPOINTS.EMAIL_LOGIN,a).then(function(e){var t,r=e.data.success;return r&&e.data.data&&(t=e.data.data.dstoken,s.put("bbtoken",t)),r})}function u(e,r,n){return t({method:"POST",url:o+e,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(r)}).then(function(e){n.resolve({success:e.data.success,bbtoken:e.data.data&&e.data.data.dstoken?e.data.data.dstoken:null})},function(e){n.resolve({success:!1,status:e.data.status})})}function d(t,o,i){var c=r.defer(),s={id:t},l=o?e.ENDPOINTS.CONFIRM_OAUTH_SIGNUP:e.ENDPOINTS.CONFIRM_OAUTH;return o&&(s.User_language=a),o&&i?n.open(e.REQUIRE_EMAIL_TEMPLATE,"RequireEmailController","requireEmail","require-email",{successCallback:function(){function e(e){s.User_email=e,s.User_language=a,u(l,s,c)}return e}},null,null,null,!0):u(l,s,c),c.promise}function p(e,t){var r,o=location.origin+location.pathname,n=i.search(),a=e||{};n.auth="idplaceholder",n=angular.merge({},a,n),r=c+"/"+t+"?ret="+encodeURIComponent(o+"?"+$.param(n)),r=r.replace("idplaceholder","{id}"),location.href=r}return{authenticate:l,confirmOAuth:d,oAuthRedirect:p}}]),app.component("productCardDiscover",{templateUrl:"components/product-card-discover.html",controllerAs:"discover",bindings:{product:"<",select:"&"},controller:["$scope","$timeout","$state","$location","publicDataSrv","modalSrv","discoverSrv","PROMOTER_INFO","promoterInfoSrv","$q",function(e,t,r,o,n,a,i,c,s,l){var u=this;u.getCommission=function(e,t){var r=Math.floor(e*t)/100;return parseFloat(r.toFixed(2))},u.renderPrice=function(e){return parseFloat(Number(e).toFixed(2))},u.$onInit=function(){u.productInfo={currency:n.currencyToSymbol(u.product.Product_isoCurrency),product:u.product,commission:u.getCommission(u.product.Product_price,u.product.Product_promoterCommissionPercent),setProductImage:u.setProductImage}},u.setProductImage=function(e){return{backgroundImage:"url("+e+")"}},u.shareAndEarn=function(){isAuth?c.BEEVIRAL_ID?a.shareAndEarn(u.product):s.requestPromoterInfo(function(e,t){var r=l.defer();return s.submitPromoterInfo(e,t).then(function(e){e.success?(a.shareAndEarn(u.product),r.resolve()):r.reject()},r.reject),r.promise}):a.signup(u.productInfo.product.Product_bbcode)},u.selectProduct=function(){u.select()}}]}),app.controller("RequireEmailController",["successCallback",function(e){this.email="",this.loading=!1,this.callback=function(t){this.loading=!0,e(t)}}]),app.constant("REQUIRE_PROMOTER_INFO",{ENDPOINTS:{SUBMIT:"/register/beeviral/"}}),app.controller("PromoterInfoController",["$scope","successCallback","publicDataSrv","$q","modalSrv",function(e,t,r,o,n){var a,i,c=this;c.loading=!0,c.currency=null,c.country=null,c.currencies=[],c.countries=[],a=r.getCountries().then(function(e){c.countries=e,c.country=c.countries[0].iso}),i=r.getCurrencies().then(function(e){c.currencies=e,c.currency=c.currencies[0].Currency_isoCode}),o.all([a,i]).then(function(){c.loading=!1,r.getGeo().then(function(e){c.country=e.COUNTRY,c.currency=e.CURRENCY})}),c.callback=function(){c.loading=!0,t(c.currency,c.country).then(function(){e.closeThisDialog()},function(){n.defaultNotice(),c.loading=!1})}}]),app.service("promoterInfoSrv",["modalSrv","$q","$http","REQUIRE_PROMOTER_INFO","BLOOMBEES_API_URL","USER_ID","$cookies","PROMOTER_INFO",function(e,t,r,o,n,a,i,c){function s(t){return e.open("partials/modals/require_promoter_info.html","PromoterInfoController","requirePromoterInfo","require-promoter-info",{successCallback:function(){return t}})}function l(e,t){return r.post(n+o.ENDPOINTS.SUBMIT+a,{Store_currency:e,Store_country:t}).then(function(e){return e.data.data&&200===e.data.status&&(i.put("bbrefresh",1),c.BEEVIRAL_ID=e.data.data.Store_beeViralId),{success:e.data.success,promoterInfo:e.data.data?e.data.data:null}})}return{requestPromoterInfo:s,submitPromoterInfo:l}}]),app.directive("scrollControls",["$log","$timeout",function(e,t){return{replace:!0,restrict:"E",template:'<div><div class="slider-controls slide-left"><span class="icon bb-icon-left_arrow"></span></div><div class="slider-controls slide-right" ng-hide="noRight"> <span class="icon bb-icon-right-angle"></span></div></div>',scope:{container:"@",show:"=",appendToContainer:"<"},link:function(e,r){var o=this;o.getVisibleWidth=function(e){return e.parent().width()-e.width()},o.getChildrenWidth=function(e){var t,r=0,o=e.children();for(t=0;t<o.length;t++)r+=$(o[t])[0].offsetWidth;return r},t(function(){var t=$(e.container),n=t.width(),a=o.getChildrenWidth(t),i=r.find(".slider-controls.slide-left"),c=r.find(".slider-controls.slide-right");o.width=o.getChildrenWidth(t),e.appendToContainer&&(t.append('<div class="slider-controls slide-left hidden-xs"><span class="icon bb-icon-left_arrow"></span></div><div class="slider-controls slide-right hidden-xs" ng-hide="noRight" ng-show="show"> <span class="icon bb-icon-right-angle"></span></div>'),i=t.find(".slider-controls.slide-left"),c=t.find(".slider-controls.slide-right"),c.css("right",o.width+"px"),r.addClass("hidden")),a<=n&&($(i).hide(),$(c).hide()),0===t.scrollLeft()&&$(i).hide(),t.on("scroll",function(){var r=t.scrollLeft(),n=t[0].scrollWidth-t[0].clientWidth;n!==o.offset&&o.offset&&(o.width=o.getChildrenWidth(t)),o.offset=n,n<2?($(i).hide(),$(c).hide()):(0===r&&0!==n?$(i).fadeOut(300):$(i).fadeIn(300),r===n&&0!==n?$(c).fadeOut(300):$(c).fadeIn(300)),e.appendToContainer&&c.css("right",o.width+"px")}),i.hover(function(){var e=2*o.getChildrenWidth(t);t.animate({scrollLeft:0},e)},function(){t.stop(!0,!1)}),c.hover(function(){var e=o.getChildrenWidth(t),r=2*e;t.animate({scrollLeft:e},r)},function(){t.stop(!0,!1)})})}}}]),app.directive("shareAndEarn",["ngDialog",function(e){return{restrict:"A",scope:{product:"<"},controller:["$log","modalSrv",function(e,t){}],link:function(e,t,r){}}}]),app.component("signupForm",{templateUrl:"partials/modals/signup-form.html",controllerAs:"signupController",restrict:"E",bindings:{bbcode:"@"},replace:!0,controller:["SIGNUP","LOGIN","signupSrv","modalSrv","BLOOMBEES_OAUTH_URL","translationsSrv","loginSrv","locationSrv",function(e,t,r,o,n,a,i,c){function s(e){o.openWithOptions({template:"partials/modals/account-exists.html",controller:["ngDialog","modalSrv","$scope",function(t,r,o){var n=this;d.fadeOut(200),n.signin=function(){r.closeAll(),r.login(e)},n.retypeEmail=function(){o.closeThisDialog(),d.fadeIn(300),p.focus()}}],controllerAs:"$ctrl",plain:!1})}var l=this,u="#"+o.getOpenDialogs()[0],d=angular.element(document).find(u),p=d.find("input#email");l.registerForm={},l.links=e.LINKS,l.name="",l.email="",l.password="",l.repeatPassword="",l.PASSWORD_MIN_LENGTH=e.PASSWORD_MIN_LENGTH,l.oAuthRedirect=i.oAuthRedirect.bind(i,{bbcode:l.bbcode,signup:!0}),l.oAuthUrl=n,l.loading=!0,l.submit=function(){l.loading=!0,r.signup(l.name,l.email,l.password).then(function(e){e?l.bbcode?c.reloadWithParams({bbcode:l.bbcode,newAccount:!0}):c.reloadWithParams({newAccount:!0}):(o.defaultNotice(),l.loading=!1)},function(e){l.loading=!1,409===e.status?(p.val(""),l.registerForm.email.$setViewValue(""),s(l.bbcode)):o.defaultNotice()})},l.goToLogin=function(){o.closeAll(),o.login(l.bbcode)},l.loading=!1}]}),app.constant("SIGNUP",{ENDPOINT:"/register/user",LINKS:{TERMS_AND_CONDITIONS:"https://bloombees.com/terms-and-conditions",PRIVACY_POLICY:"https://bloombees.com/privacy-policy"},PASSWORD_MIN_LENGTH:8}),app.service("signupSrv",["SIGNUP","LOGIN","LANGUAGE","loginSrv","$q","$http","BLOOMBEES_API_URL",function(e,t,r,o,n,a,i){function c(t,c,s){var l=n.defer(),u={User_email:c,User_name:t,User_password:s,User_language:r};return a.post(i+e.ENDPOINT,u).then(function(e){e.data&&e.data.success?o.authenticate(c,s).then(function(e){l.resolve(e)}):l.reject(e)},l.reject),l.promise}return{signup:c}}]),app.component("voteProduct",{templateUrl:"components/vote-product.html",bindings:{product:"<",voted:"="},controllerAs:"vote",controller:["$timeout","voteSrv","USER_ID",function(e,t,r){var o=this;o.isVoted=o.product.Product_liked||o.product.Product_disliked,o.like=function(){o.product.Product_liked?o.unlike():t.like(o.product.Product_id,o.product.Product_bbcode,r).then(function(t){o.product=t.data.Products[0],o.isVoted=!0,o.voted=!0,e(function(){o.voted=!1},1e3)})},o.dislike=function(){o.product.Product_disliked?o.unlike():t.dislike(o.product.Product_id,o.product.Product_bbcode,r).then(function(t){o.product=t.data.Products[0],o.isVoted=!0,o.voted=!0,e(function(){o.voted=!1},1e3)})},o.unlike=function(){t.unlike(o.product.Product_id,o.product.Product_bbcode,r).then(function(e){o.product=e.data.Products[0],o.isVoted=!1})}}]}),app.constant("VOTE",{ENDPOINTS:{LIKE:"/beeViral/likes/like",DISLIKE:"/beeViral/likes/dislike",UNLIKE:"/beeViral/likes/unlike"}}),app.service("voteSrv",["$resource","BLOOMBEES_API_URL","VOTE",function(e,t,r){function o(o,n,a){var i={Product_id:o,Product_bbcode:n,User_id:a};return e(t+r.ENDPOINTS.LIKE).save(i).$promise}function n(o,n,a){var i={Product_id:o,Product_bbcode:n,User_id:a};return e(t+r.ENDPOINTS.DISLIKE).save(i).$promise}function a(o,n,a){var i={Product_id:o,Product_bbcode:n,User_id:a};return e(t+r.ENDPOINTS.UNLIKE).save(i).$promise}return{like:o,dislike:n,unlike:a}}]),app.constant("DISCOVER",{ENDPOINTS:{PRODUCTS:"/beeViral/products",DISCOVER:"/beeViral/discover",CATEGORIES:"/beeViral/cats?__reload",SUBCATEGORIES:"/beeViral/cats?__reload",STOREFRONT:"/beeViral/storefront/products",SOCIALNETWORK:"/socialnetworks/facebook/check"},DEFAULTS:{LIMIT:12,PRICE_MAX:3e3},ORDER:{commission:!0,popular:!0,date:!0,seller:!0},VIEW:{popular:"Popular",recommended:"Recommended",all:"All"}}),app.controller("DiscoverController",["$timeout","$scope","$rootScope","discoverSrv","USER_ID","publicDataSrv","modalSrv","LANGUAGE","DISCOVER","$state","PROMOTER_INFO","promoterInfoSrv","$q","translationsSrv",function(e,t,r,o,n,a,i,c,s,l,u,d,p,f){var m,h,g=this;if(g.products={},g.search=[],g.selectedProducts=[],g.isModalFilters=!1,g.loadMoreData={limit:s.DEFAULTS.LIMIT,offset:0},g.currentLimit=g.loadMoreData.offset+g.loadMoreData.limit,g.currency=a.getActiveCurrency().Currency_symbol,g.orderBy=o.getOrderBy(),g.views=o.getViews(),g.filters={priceMin:l.params.priceMin||0,priceMax:l.params.priceMax||s.DEFAULTS.PRICE_MAX,order:g.orderBy[l.params.order]?l.params.order:null},l.params.uniqueId&&(g.filters.Store_uniqueId=l.params.uniqueId),g.searchTitle=l.params.view||null,g.price={active:l.params.priceMin&&l.params.priceMax,options:{hidePointerLabels:!0,hideLimitLabels:!0,boundPointerLabels:!1,ceil:s.DEFAULTS.PRICE_MAX,floor:0,onEnd:function(e,t,r){g.price.active=g.filters.priceMin+g.filters.priceMax===t+r,g.isModalFilters||g.filterProducts()}}},g.lang=c,g.categories=o.categories,g.sections=o.sections,i.onboarding(),l.params.view&&g.views[l.params.view]&&g.search.push({view:!0,text:l.params.view}),l.params.cat&&g.search.push({category:!0,text:l.params.cat}),l.params.subcat&&g.search.push({subcategory:!0,text:l.params.subcat}),l.params.search)for(h=l.params.search.split(","),m=0;m<h.length;m++)g.search.push({text:h[m]});l.params.newAccount&&(l.go(l.current,{newAccount:null},{notify:!1,reload:!1}),r.$emit("alert",{type:"success",message:"successfulPromoterSignup"})),g.showFiltersModal=function(){g.isModalFilters=!0,i.openWithOptions({template:"<discover-filters></discover-filters>",plain:!0})},g.applyFilters=function(){g.isModalFilters=!1,l.go(l.current,g.setUrlParams(g.search,g.filters),{reload:!0,notify:!1})},g.checkActiveFilters=function(){return g.price.active||g.filters.order},g.clearAllFilters=function(){g.price.active=!1,g.filters.priceMin=0,g.filters.priceMax=s.DEFAULTS.PRICE_MAX,g.filters.order=null,l.transitionTo(l.current,g.setUrlParams(g.search,g.filters),{reload:!1,notify:!1})},g.clearAll=function(){g.search.length=0,g.price.active=!1,g.filters.order=null,l.transitionTo(l.current,g.setUrlParams([],{}),{reload:!1,notify:!1})},g.getCategoryName=function(e){return e[g.lang]},g.addCategory=function(e,t){var r={id:e,category:!0,text:t};g.search.push(r)},g.addSubcategory=function(e,t){var r={id:e,subcategory:!0,text:t};g.search.push(r)},g.getProductSectionType=function(e,t){return{text:t,popular:e.indexOf("popular")>-1,recommended:e.indexOf("recommended")>-1,all:e.indexOf("all")>-1}},g.viewAll=function(e){var t={text:e.text};g.searchTitle=e.text,e.all&&(t.param="all"),e.popular&&(t.param="popular"),e.recommended&&(t.param="recommended"),g.search.push(t)},g.loadMore=function(){g.loadingMore=!0,g.loadMoreData.offset+=g.loadMoreData.limit,o.getSearchResults(g.loadMoreData.offset,g.loadMoreData.limit,g.search,g.filters).then(function(e){g.searchResults=g.searchResults.concat(e.data.Products),g.currentLimit=g.loadMoreData.offset+g.loadMoreData.limit,g.loadingMore=!1})},g.filterProducts=function(){g.loading=!0,l.go(l.current,g.setUrlParams(g.search,g.filters),{reload:!1,notify:!1}),o.getSearchResults(0,s.DEFAULTS.LIMIT,g.search,g.filters).then(function(e){g.searchResults=e.data.Products,g.loading=!1})},g.checkMainCategory=function(e){var t=!1;return e.map(function(e){e.category&&(t=!0)}),t},g.setUrlParams=function(e,t){var r={},o={},n=[],a=[];return e.map(function(e){e.category||e.subcategory||e.param||e.view?(e.category&&(r.cat=e.text),e.subcategory&&n.push(e.text),e.param&&(r.view=e.param),e.view&&(r.view=e.text)):a.push(e.text)}),r.search=a.join(","),r.subcat=n.join(","),g.price.active?o=t:o.order=t.order,l.params.uniqueId&&(r.uniqueId=l.params.uniqueId),angular.merge(r,o)},g.selectProduct=function(e){var t,r=g.selectedProducts.indexOf(e);return r>-1?(t=!1,g.selectedProducts.splice(r,1),o.selectedProducts=g.selectedProducts):(t=!0,g.selectedProducts.push(e),o.selectedProducts=g.selectedProducts),t},g.clearSelectedProducts=function(){g.selectedProducts.length=0,o.selectedProducts=g.selectedProducts},g.updateAddedProducts=function(e){angular.forEach(g.sections,function(t){t.Section_items.map(function(t){e.indexOf(t.Product_id)>-1&&(t.StoreFront_dateInserted=!0)})}),g.searchResults&&g.searchResults.length>0&&g.searchResults.map(function(t){e.indexOf(t.Product_id)>-1&&(t.StoreFront_dateInserted=!0)})},g.isSelectedProduct=function(e){return o.isSelectedProduct(e)},g.getTranslationFromElement=function(e){return f.getTranslationFromElement(e)},g.addToStorefront=function(){g.selectedProducts.length>1?o.addProductsToStorefront(g.selectedProducts).then(function(r){r.success?(g.updateAddedProducts(g.selectedProducts),g.clearSelectedProducts(),e(function(){t.$emit("alert",{type:"success",message:"addedProductsToStorefront"})})):e(function(){t.$emit("alert",{type:"error",message:"defaultError"})})}):1===g.selectedProducts.length&&o.addProductToStorefront(g.selectedProducts[0]).then(function(r){r.success?(g.updateAddedProducts(g.selectedProducts),g.clearSelectedProducts(),e(function(){t.$emit("alert",{type:"success",message:"addedProductToStorefront"})})):e(function(){t.$emit("alert",{type:"error",message:"defaultError"})})})},isAuth&&l.params.bbcode&&o.getProductByBbcode(l.params.bbcode).then(function(e){var t=e.data.Products[0];u.BEEVIRAL_ID?i.shareAndEarn(t):d.requestPromoterInfo(function(e,r){var o=p.defer();return d.submitPromoterInfo(e,r).then(function(e){e.success?(i.shareAndEarn(t),o.resolve()):o.reject()},o.reject),o.promise})}),t.$watch(angular.bind(g,function(){return g.search}),function(t,r){var n=g.checkMainCategory(r);g.hasMainCategory=g.checkMainCategory(t),t.length>0?(g.loading=!0,(g.hasMainCategory&&!n||angular.equals(t,r))&&o.getSubcategories().then(function(e){g.subcategories=e.data.TagCats}),l.go(l.current,g.setUrlParams(g.search,g.filters),{reload:!1,notify:!1}),e(function(){var e,t=angular.element(".tags"),r=angular.element("ul.tag-list"),o=t.find("input"),n=0;for(e=0;e<r[0].children.length;e++)n+=$(r[0].children[e])[0].offsetWidth+5;r.css("min-width",n),t.animate({scrollLeft:o[0].offsetWidth+r[0].offsetWidth},"slow")}),o.getSearchResults(0,s.DEFAULTS.LIMIT,t,g.filters).then(function(e){g.searchResults=e.data.Products,g.loading=!1})):l.params.bbcode||(angular.element("ul.tag-list").css("min-width",0),g.clearAll())},!0),r.$on("currencyChanged",function(){var e=isAuth?n:null,t=l.params.uniqueId||null;g.search.length>0&&(g.loading=!0,o.getSearchResults(0,g.currentLimit,g.search,g.filters).then(function(e){g.searchResults=e.data.Products,g.loading=!1})),o.getProducts(0,s.DEFAULTS.LIMIT,null,e,t).then(function(r){g.products.all=r.data.Products,o.getProducts(0,8,"popular",e,t).then(function(r){g.products.popular=r.data.Products,o.getProducts(0,8,"recommended",e,t).then(function(e){g.products.recommended=e.data.Products})})})})}]),app.service("discoverSrv",["$log","userInfoSrv","publicDataSrv","$resource","DISCOVER","BLOOMBEES_API_URL","USER_ID","LANGUAGE",function(e,t,r,o,n,a,i,c){var s=this;s.categories=[],s.selectedProducts=[],s.getProducts=function(e,t,i,c,s){var l={limit:t,cursor:e,currency:r.getActiveCurrency().Currency_isoCode},u=a+n.ENDPOINTS.PRODUCTS;return s&&(l.Store_uniqueId=s),i&&(l.modifier=i,u+="?:modifier"),isAuth&&(l.User_id=c),o(u,l).get().$promise},s.getCategories=function(e){return o(a+n.ENDPOINTS.CATEGORIES,{lang:e}).get().$promise},s.getSubcategories=function(e){return o(a+n.ENDPOINTS.SUBCATEGORIES,{lang:e}).get().$promise},s.getOrderBy=function(){return n.ORDER},s.getViews=function(){return n.VIEW},s.getSearchResults=function(e,t,c,s){var l={limit:t,cursor:e,currency:r.getActiveCurrency().Currency_isoCode},u=a+n.ENDPOINTS.PRODUCTS,d=null,p=[],f=null,m=[];return c.map(function(e){e.category||e.subcategory||e.param||e.view?(e.category&&(d=e.text),e.subcategory&&p.push(e.text),e.param&&(f=e.param),e.view&&(f=e.text)):m.push(e.text)}),m.length>0&&(l.search=m.join(",")),p.length>0&&(l.subcat=p.join(",")),d&&(l.cat=d),f&&(l.modifier=f,u+="?:modifier"),isAuth&&(l.User_id=i),l=angular.merge(l,s),o(u,l).get().$promise},s.getProductByBbcode=function(e){var t={Product_bbcode:e,User_id:i,currency:r.getActiveCurrency().Currency_isoCode};return o(a+n.ENDPOINTS.PRODUCTS,t).get().$promise},s.selectProduct=function(e){s.selectedProducts.push(e)},s.deselectProduct=function(e){var t=s.selectedProducts.indexOf(e);t>-1&&s.selectedProducts.splice(t,1)},s.isSelectedProduct=function(e){return s.selectedProducts.indexOf(e)>-1},s.addProductToStorefront=function(e){return o(a+n.ENDPOINTS.STOREFRONT+"/:user_id/:product_id",{user_id:i,product_id:e}).save().$promise},s.addProductsToStorefront=function(e){var t={Product_ids:JSON.stringify(e)};return o(a+n.ENDPOINTS.STOREFRONT+"/:user_id",{user_id:i}).save(t).$promise},s.getProductSections=function(e){var t=isAuth?i:null,s={lang:c,User_id:t,Store_uniqueId:e,currency:r.getActiveCurrency().Currency_isoCode};return o(a+n.ENDPOINTS.DISCOVER,s).get().$promise}}]),app.factory("$storage",["$window",function(e){return{get:function(t){var r=e.localStorage[t];return r?JSON.parse(r):null},set:function(t,r){e.localStorage[t]=JSON.stringify(r)},remove:function(t){e.localStorage.removeItem(t)}}}]),app.service("locationSrv",["$location",function(e){function t(e,t){var r,o=t.split("?")[0],n=[],a=t.indexOf("?")!==-1?t.split("?")[1]:"";if(""!==a){for(n=a.split("&"),r=n.length-1;r>=0;r-=1)n[r].split("=")[0]===e&&n.splice(r,1);o=o+"?"+n.join("&")}return o}function r(e){var r=location.href;e.forEach(function(e){r=t(e,r)}),location.href=r}function o(t){var r=location.origin+location.pathname,o=angular.merge({},e.search(),t);location.href=r+"?"+$.param(o)}return{reloadWithoutParams:r,reloadWithParams:o}}]),app.directive("bbAlert",["$timeout",function(e){return{restrict:"E",replace:!0,templateUrl:"components/bb-alert.component.html",controllerAs:"bbAlert",link:function(t,r,o,n){var a,i=r.find(".bb-alert");t.closeAlert=function(){i.addClass("zoomOut"),i.removeClass("fadeInUp"),e(function(){n.setMessageAndType(null,null)},500),e.cancel(a)},t.getAlertType=function(){return"bb-alert-icon__"+n.type},t.$on("alert",function(r,o){n.setMessageAndType(o.message,o.type),i.removeClass("zoomOut"),i.addClass("fadeInUp"),a=e(function(){t.closeAlert()},5500)}),t.$on("destroy",function(){t.closeAlert()})},controller:function(){var e=this;e.setMessageAndType=function(t,r){e.message=t,e.type=r}}}}]),app.component("currencySwitcher",{replace:!0,restrict:"E",bindings:{onChange:"&"},templateUrl:"components/currency-switcher.component.html",controller:["$log","$rootScope","$timeout","userInfoSrv","publicDataSrv",function(e,t,r,o,n){var a=this;a.selectedCurrency=n.getActiveCurrency(),a.currencies=[],a.setActive=function(e){a.selectedCurrency.Currency_isoCode!==e.Currency_isoCode&&(r(function(){t.$emit("currencyChanged",{lang:e.Currency_isoCode})}),a.selectedCurrency=n.changeCurrency(e))},a.$onInit=function(){n.getCurrencies().then(function(e){a.currencies=e})}}]}),app.directive("bbTooltip",["$log",function(e){return{restrict:"A",scope:{title:"@bbTooltip",placement:"@bbTooltipPlacement"},link:function(e,t){var r=angular.element(t)[0],o={title:e.title,placement:e.placement||"top"};$(r).tooltip(o),t.hover(function(){$(r).tooltip("show")},function(){$(r).tooltip("hide")})}}}]),app.directive("bbValidateForm",["$log","bbValidateFormSrv",function(e,t){return{restrict:"A",link:function(e,r,o){var n,a,i,c,s,l=angular.element(r)[0];n=$(l),c=n.find(".bb-input"),s=function(){a=!0,i=!0,c.each(function(){$(this).hasClass("touched")||(i=!1),!$(this).hasClass("has-error")&&i||(a=!1)}),a?(n.addClass("valid"),$('button[type="submit"]').prop("disabled",!1)):(n.removeClass("valid"),$('button[type="submit"]').prop("disabled",!0))},c.each(function(e,r){var o,n,a,i,l;o=$(r),n=$("input, textarea",o),a=$(".form-alert",o),i=function(e){o.addClass("has-error"),a.find("[data-error]").each(function(){$(this).removeClass("active")}),a.find('[data-error="'+e+'"]').addClass("active")},l=function(){var e,r;e=n.val(),r=t.validateField(e,n,c),o.removeClass("has-error"),r?(o.removeClass("has-value"),i(r)):o.addClass("has-value")},n.on("focus",function(){o.addClass("dirty")}),n.on("blur input",function(){var e=n.val();e&&e.length&&o.addClass("dirty"),$(".has-value").length===c.length-1&&o.addClass("touched"),o.hasClass("touched")&&l(),s()}),n.on("change",function(){o.hasClass("touched")||l(),o.addClass("touched")})})}}}]),app.service("bbValidateFormSrv",function(){function e(e,t){var r,o;return t?(r=new RegExp(t),o=r.test(e)):o=!0,o}function t(e,t){var r=!e||!e.length;return!(t&&r)}function r(e,t){return!t||e.length>=t}function o(e,t){return!t||e.length<=t}function n(e,t){return!t||e===t}function a(a,i,c){var s=c.find('[name="password"]'),l="";return t(a,i.attr("required"))||(l="required"),r(a,i.attr("minlength"))||(l="minlength"),o(a,i.attr("maxlength"))||(l="maxlength"),e(a,i.attr("pattern"))||(l="pattern"),"checkPassword"===i.attr("name")&&s&&!n(a,s.val())&&(l="checkPassword"),l||null}return{validateField:a}}),app.directive("setLang",["$window","$location",function(e,t){return{restrict:"A",link:function(r,o,n){t.search("lang",null),o.click(function(r){r.preventDefault(),t.search("lang",n.setLang),e.location.replace(t.absUrl())})}}}]),app.constant("PUBLIC_DATA",{ENDPOINTS:{COUNTRIES:"/public/data/countries",CURRENCIES:"/checkouts/currencies",TIMEZONES:"/checkouts/timezones",CURRENCY_EXCHANGE:"/finances/exchange"},DEFAULTS:{CURRENCY:{Currency_isoCode:"EUR",Currency_symbol:"€"}},CURRENCIES:{EUR:"€",USD:"$",RUB:"₽",PLN:"zł",GBP:"£"},DAYS_PER_MONTH:[31,29,31,30,31,30,31,31,30,31,30,31]}),app.service("publicDataSrv",["$q","$http","$resource","PUBLIC_DATA","BLOOMBEES_API_URL","callSrv",function(e,t,r,o,n,a){function i(){return a.get("countries",o.ENDPOINTS.COUNTRIES).then(function(e){var t,r,o=[];if(e.data&&e.data.data&&e.data.data.iso){t=e.data.data.iso,
v=e.data.data.geo;for(r in t)t.hasOwnProperty(r)&&o.push(t[r])}return o})}function c(){var t=e.defer();return v?t.resolve(v):i().then(function(){t.resolve(v)},t.resolve),t.promise}function s(){var e,t=[];for(e=0;e<=11;e++)t[e]=e+1;return t}function l(e){var t,r=[],o=(new Date).getFullYear(),n=e||10;if(n>=0)for(t=0;t<=n;t++)r[t]=t+o;else for(t=0;t>n;t--)r.push(t+o);return r}function u(e){var t,r=o.DAYS_PER_MONTH[e-1],n=[];for(t=0;t<r;t++)n.push(t+1);return n}function d(e){return o.CURRENCIES[e]||e}function p(e){return o.CURRENCIES[e]||null}function f(){return a.get("currencies",o.ENDPOINTS.CURRENCIES).then(function(e){var t=null;return e.data&&e.data.success&&e.data.data&&(t=e.data.data),t})}function m(e){return b.Currency_isoCode!==e.Currency_isoCode&&(b=e),b}function h(){return b}function g(){var t=e.defer();return a.get("timezones",o.ENDPOINTS.TIMEZONES).then(function(e){var r=e.data.data;r&&r.Timezones?t.resolve(r.Timezones):t.reject(e)},t.reject),t.promise}var v=null,b=o.DEFAULTS.CURRENCY;return{getCountries:i,getGeo:c,getMonths:s,getYears:l,getDays:u,currencyToSymbol:d,getCurrencySymbol:p,getCurrencies:f,getActiveCurrency:h,changeCurrency:m,getTimezones:g}}]),app.service("callSrv",["$q","$http","BLOOMBEES_API_URL",function(e,t,r){function o(e,o,n,i){var c,s;return a[e]?s=a[e]:(c={method:o,url:r+n},i&&(c.data=i),s=t(c),a[e]=s),s}function n(e,t){return o(e,"GET",t)}var a={};return{get:n}}]),app.service("modalSrv",["$timeout","$storage","$cookies","ngDialog","translationsSrv","publicDataSrv","discoverSrv","$state",function(e,t,r,o,n,a,i,c){function s(e,t){return e&&t&&o.open({template:"partials/modals/notice.html",className:"ngdialog-theme-plain modal-notice",controller:function(){this.text=e,this.okLabel=t},controllerAs:"modal"}),null}function l(e){return o.open(e)}function u(e,t,r,n,a,i,c,s,l){var u,d=null;return e&&(u={template:e,className:"ngdialog-theme-plain"},t&&r&&(u.controller=t,u.controllerAs=r),s&&(u.preCloseCallback=s),a&&(u.resolve=a),n&&(u.className=u.className+" "+n),i&&(u.plain=i),c&&(u.data=c),l&&(u.showClose=!1,u.closeByEscape=!1,u.closeByDocument=!1),d=o.open(u)),d}function d(e,t,r){return o.openConfirm({template:"partials/modals/confirm.html",className:"ngdialog-theme-plain",controller:function(){e&&t&&r&&(this.text=e,this.yesLabel=t,this.noLabel=r)},controllerAs:"modal"})}function p(){o.closeAll()}function f(){s("Something went wrong","Ok")}function m(e){return u(e?'<signup-form bbcode="'+e+'"></signup-form>':"<signup-form></signup-form>",null,null,"signup-modal",null,!0)}function h(e){return u(e?'<login-form bbcode="'+e+'"></login-form>':"<login-form></login-form>",null,null,"login-modal",null,!0)}function g(){var e=window.sessionStorage;try{return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}}function v(){var n=t.get("bloombees");g()?isAuth||(n?n.beeviral?n.beeviral.onboardingComplete||e(function(){o.openConfirm({template:"partials/modals/onboarding.html",className:"ngdialog-theme-default share-and-earn-modal onboarding-modal",closeByDocument:!1,plain:!1}).then(function(){n.beeviral.onboardingComplete=!0,t.set("bloombees",localStorage)})},100):(n.beeviral={onboardingComplete:!1},t.set("bloombees",n)):(t.set("bloombees",{beeviral:{onboardingComplete:!1}}),n=t.get("bloombees"),e(function(){o.openConfirm({template:"partials/modals/onboarding.html",className:"ngdialog-theme-default share-and-earn-modal onboarding-modal",closeByDocument:!1,plain:!1}).then(function(){n.beeviral.onboardingComplete=!0,t.set("bloombees",n)})},100))):(r.get("onboarding"),r.get("onboarding")||e(function(){o.openConfirm({template:"partials/modals/onboarding.html",className:"ngdialog-theme-default share-and-earn-modal onboarding-modal",closeByDocument:!1,plain:!1}).then(function(){r.put("onboarding",!0)})},100))}function b(t){var r,o,n,s,l=t.Product_isoCurrency||t.Performance_currencyIsoCode;return o=function(e,t){var r=Math.floor(e*t)/100;return parseFloat(r.toFixed(2))},s={currency:a.currencyToSymbol(l),product:t,commission:o(t.Product_price,t.Product_promoterCommissionPercent),resolved:!1},i.getProductByBbcode(s.product.Product_bbcode).then(function(t){s.product=angular.merge(s.product,t.data.Products[0]),s.product.Product_url=t.data.Products[0].Product_Url,e(function(){s.resolved=!0},200)}),n=function(){return c.go(c.current,{bbcode:null},{notify:!1,reload:!1}),!0},r=["$scope","$window","$resource","Socialshare","FACEBOOK_ID","DISCOVER","BLOOMBEES_API_URL",function(e,t,r,o,n,a,i){this.product=e.ngDialogData.product,this.voted=!1,this.shared=!1,this.params=c.params,this.params.bbcode=this.product.Product_bbcode,c.go(c.current,this.params,{reload:!1,notify:!1}),this.renderPrice=function(e){return parseFloat(Number(e).toFixed(2))},this.share=function(e){var t={socialshareUrl:this.product.Product_Url};"facebook"===e&&(t.socialshareVia=n),"email"===e&&(t.socialshareSubject="Subject here",t.socialshareBody="Email body here"),o.share({provider:e,attrs:t}),this.shared=!0},this.closeModal=function(){p()},this.keepSharing=function(){this.shared=!1,r(i+a.ENDPOINTS.SOCIALNETWORK).get()},this.copyLink=function(e){var r,o=angular.element(t.document.body),n=angular.element("<textarea/>");n.css({position:"fixed",opacity:"0"}),n.val(e),o.append(n),n[0].select(),r=document.execCommand("copy");try{if(!(r=document.execCommand("copy")))throw r}catch(r){t.prompt("Copy to clipboard, please",e)}n.remove()}}],u("partials/modals/discover-share-and-earn.html",r,"$ctrl","share-and-earn-modal",null,!1,s,n)}function S(){return o.getOpenDialogs()}return{notice:s,confirm:d,open:u,openWithOptions:l,closeAll:p,defaultNotice:f,signup:m,login:h,onboarding:v,shareAndEarn:b,getOpenDialogs:S}}]),app.service("userInfoSrv",["$log","$http","$q","$resource","$cookies","USER_ID","ENVIRONMENT","BLOOMBEES_API_URL",function(e,t,r,o,n,a,i,c){var s=this;s.hash=n.get("bbhash"),s.headers={token:{"X-DS-TOKEN":n.get("bbtoken")},webKey:{"X-WEB-KEY":i}},s.current={},s.user={},s.store={},s.isLoaded=!1,s.get=function(e){return o("/dev_api").get({file:e}).$promise},s.getUserById=function(e){return o(c+"/users/byid/:id",{id:e},{get:{method:"GET",headers:s.headers.token}}).get().$promise},s.getStoreById=function(e){return o(c+"/manage/stores/:id",{id:e},{get:{method:"GET",headers:s.headers.token}}).get().$promise},s.getProductById=function(e){return o(c+"/checkouts/bybbcode/:id",{id:e},{get:{method:"GET",headers:s.headers.webKey}}).get().$promise},s.getStoreProducts=function(e,t){return o(c+"/checkouts/bystore/:store",{store:s.store.Store_uniqueId,offset:e,limit:t},{get:{method:"GET",headers:s.headers.webKey}}).get().$promise},s.getStore=function(){return s.init().then(function(){return s.store})},s.getUser=function(){return s.init().then(function(){return s.user})},s.getUserInfo=function(){return s.init().then(function(){return{user:s.user,store:s.store,headers:s.headers}})},s.init=function(){var e=r.defer();return s.isLoaded?e.resolve(s.isLoaded):isAuth?s.getUserById(a).then(function(t){s.user=t.data,s.getStoreById(t.Store_id).then(function(t){s.store=t.data,s.isLoaded=!0,e.resolve(s.isLoaded)})}):e.resolve(s.isLoaded),e.promise}}]),app.constant("TRANSLATIONS",{TRANSLATIONS_ENDPOINT:"/public/resources/translations/",TRANSLATIONS_PREFFIX:"bloombees;webapp;"}),app.service("translationsSrv",function(){function e(e){var t=angular.element("translations")[0],r=e.split(";"),o=4===r.length?r[2]+"_"+r[3]:r[0]+"_"+r[1];return t.dataset[o]}return{getTranslationFromElement:e}});